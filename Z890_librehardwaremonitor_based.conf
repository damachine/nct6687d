# MSI MAG Z890 TOMAHAWK WIFI - LibreHardwareMonitor-basierte Konfiguration
# Basierend auf Windows LibreHardwareMonitor NCT6687D Implementierung
# Speziell angepasst für MSI Z890 Motherboards mit bekannten EC-Problemen

chip "nct6687-*"
    # Spannungen - Basierend auf LibreHardwareMonitor NCT6687D.cs
    # Diese Zuordnung entspricht der Windows-Implementierung
    label in0         "+12V"          # 12V Hauptversorgung
    label in1         "+5V"           # 5V Standby
    label in2         "CPU Soc"       # CPU SoC Spannung (LibreHardwareMonitor Standard)
    label in3         "DRAM"          # Arbeitsspeicher-Spannung
    label in4         "CPU Vcore"     # CPU Kernspannung
    label in5         "Chipset"       # Chipsatz-Spannung
    label in6         "CPU SA"        # CPU System Agent
    label in7         "Voltage #2"    # Zusätzliche Spannung
    label in8         "AVCC3"         # AVCC3 Spannung
    label in9         "CPU 1P8"       # CPU 1.8V
    label in10        "CPU VDDP"      # CPU VDDP
    label in11        "+3.3V"         # 3.3V Rail
    label in12        "AVSB"          # Auxiliary Standby
    label in13        "VBat"          # CMOS Batterie

    # Temperaturen - LibreHardwareMonitor Standard-Zuordnung
    label temp1       "CPU"           # CPU Temperatur
    label temp2       "System"        # System-Temperatur
    label temp3       "VRM MOS"       # Spannungsregler
    label temp4       "PCH"           # Platform Controller Hub
    label temp5       "CPU Socket"    # CPU Sockel
    label temp6       "PCIe x1"       # PCIe Slot
    label temp7       "M2_1"          # M.2 Slot 1

    # Lüfter - Kritische Korrektur basierend auf LibreHardwareMonitor
    # PROBLEM: MSI Z890 hat bekannte Probleme mit Fan-Erkennung
    # LibreHardwareMonitor Issue #1513 bestätigt: Nur CPU-Lüfter wird erkannt
    
    # Nur CPU-Lüfter wird zuverlässig erkannt (bestätigt durch Windows-Tests)
    label fan1        "CPU Fan"       # CPU Lüfter (einziger zuverlässiger)
    
    # Andere Lüfter sind problematisch auf Z890 - auskommentiert bis Hardware-Fix
    # Diese Labels werden nur angezeigt wenn tatsächlich Hardware erkannt wird
    # ignore fan2                     # Pump Fan - oft nicht erkannt auf Z890
    # ignore fan3                     # System Fan #1 - Z890 Problem
    # ignore fan4                     # System Fan #2 - Z890 Problem
    # ignore fan5                     # System Fan #3 - Z890 Problem
    # ignore fan6                     # System Fan #4 - Z890 Problem
    # ignore fan7                     # System Fan #5 - Z890 Problem
    # ignore fan8                     # System Fan #6 - Z890 Problem
    
    # Alternative: Nur Labels für tatsächlich funktionierende Lüfter
    # Entkommentieren Sie diese nach Hardware-Test:
    label fan2        "Pump Fan"      # Falls AIO-Pumpe erkannt wird
    label fan3        "System Fan #1" # Falls System-Lüfter erkannt werden
    label fan4        "System Fan #2"
    label fan5        "System Fan #3"
    label fan6        "System Fan #4"
    label fan7        "System Fan #5"
    label fan8        "System Fan #6"

    # PWM-Kontrollen - Entsprechend den Lüfter-Labels
    label pwm1        "CPU Fan PWM"   # CPU-Lüfter PWM (funktioniert)
    label pwm2        "Pump Fan PWM"  # Falls verfügbar
    label pwm3        "System Fan #1 PWM"
    label pwm4        "System Fan #2 PWM"
    label pwm5        "System Fan #3 PWM"
    label pwm6        "System Fan #4 PWM"
    label pwm7        "System Fan #5 PWM"
    label pwm8        "System Fan #6 PWM"

    # Spannungs-Multiplier - Basierend auf LibreHardwareMonitor-Implementierung
    # Diese Werte entsprechen der Windows-Implementierung
    compute in0       (@ * 12), (@ / 12)    # +12V (Standard)
    compute in1       (@ * 5), (@ / 5)      # +5V (Standard)
    compute in3       (@ * 2), (@ / 2)      # DRAM (DDR5: ~1.1V)
    
    # CPU-Spannungen normalerweise 1:1 (wie in LibreHardwareMonitor)
    # compute in2       (@ * 1), (@ / 1)    # CPU Soc
    # compute in4       (@ * 1), (@ / 1)    # CPU Vcore
    # compute in5       (@ * 1), (@ / 1)    # Chipset
    # compute in6       (@ * 1), (@ / 1)    # CPU SA
    # compute in11      (@ * 1), (@ / 1)    # +3.3V

    # Ignoriere problematische Sensoren (bekannte Z890-Probleme)
    # Basierend auf LibreHardwareMonitor Issue-Reports
    ignore in7        # Voltage #2 - oft unzuverlässig auf Z890
    ignore in8        # AVCC3 - nicht immer verfügbar
    ignore in9        # CPU 1P8 - Z890-spezifisches Problem
    ignore in10       # CPU VDDP - oft ungültige Werte
    ignore in12       # AVSB - nicht zuverlässig
    ignore in13       # VBat - kann schwanken
    
    # Temperatur-Sensoren - einige sind auf Z890 problematisch
    # ignore temp6      # PCIe x1 - nicht immer vorhanden
    # ignore temp7      # M2_1 - abhängig von M.2-Bestückung

    # Temperatur-Limits (konservativ für Z890)
    set temp1_max     85              # CPU max
    set temp1_crit    95              # CPU kritisch
    set temp3_max     80              # VRM max
    set temp4_max     70              # PCH max

    # Lüfter-Mindestdrehzahlen (nur für funktionierende Lüfter)
    set fan1_min      300             # CPU Lüfter min
    # set fan2_min      300           # Pumpe min (falls erkannt)
    # set fan3_min      200           # System Lüfter min (falls erkannt)

# WICHTIGE HINWEISE für MSI MAG Z890 TOMAHAWK WIFI:
#
# 1. EC-ADRESS-PROBLEM:
#    Das "EC Invalid address: 0xFFFF" Problem ist ein bekanntes Hardware-Problem
#    mit MSI Z890 Motherboards. Auch LibreHardwareMonitor unter Windows hat
#    ähnliche Probleme (siehe Issue #1513).
#
# 2. LÜFTER-ERKENNUNG:
#    Nur der CPU-Lüfter wird zuverlässig erkannt. System-Lüfter-Erkennung
#    ist ein bekanntes Problem sowohl unter Windows als auch Linux.
#
# 3. WORKAROUNDS:
#    - Verwenden Sie force=1 Parameter: modprobe nct6687 force=1
#    - ACPI-Parameter: acpi_enforce_resources=lax
#    - BIOS-Update auf neueste Version
#    - Alternative: nct6683 Treiber verwenden
#
# 4. BIOS-EINSTELLUNGEN:
#    - Hardware Monitor: Enabled
#    - Super I/O Configuration: Enabled
#    - ACPI Settings: Standard
#    - Secure Boot: Disabled (zum Testen)
#
# 5. BEKANNTE EINSCHRÄNKUNGEN:
#    - System-Lüfter werden möglicherweise nicht erkannt
#    - Einige Spannungssensoren können ungültige Werte zeigen
#    - PWM-Kontrolle ist eingeschränkt
#    - M.2-Temperatursensoren abhängig von Hardware
#
# 6. ALTERNATIVE LÖSUNGEN:
#    Falls nct6687d nicht funktioniert:
#    - Verwenden Sie nct6683 Treiber
#    - BIOS-basierte Lüftersteuerung
#    - Externe Lüftersteuerungs-Hardware
#
# 7. DEBUGGING:
#    Für weitere Diagnose:
#    - dmesg | grep nct6687
#    - bash debug_nct6687_registers.sh
#    - bash fix_z890_ec_address_issue.sh
#
# Diese Konfiguration basiert auf der LibreHardwareMonitor-Implementierung
# und berücksichtigt bekannte Probleme mit MSI Z890 Motherboards.
